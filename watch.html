<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä¸€èµ·çœ‹ç”µå½± â€” å—ä¿æŠ¤é¡µé¢</title>
<style>
  :root {
    --bg:#111; --panel:#1e1e1e; --text:#fff;
    --accent:#ff5fa2; --nav:#222; --border:#333;
  }
  body {
    margin:0; font-family:"Segoe UI",sans-serif;
    background:var(--bg); color:var(--text);
    display:flex; flex-direction:column; height:100vh;
  }
  header {
    padding:10px; text-align:center; background:var(--nav);
    border-bottom:1px solid var(--border);
  }
  main {
    flex:1; display:flex; flex-direction:row; overflow:hidden;
  }
  #leftPanel, #rightPanel {
    padding:10px; overflow-y:auto;
  }
  #leftPanel {
    flex:2; display:flex; flex-direction:column; align-items:center;
  }
  #rightPanel {
    flex:1; border-left:1px solid var(--border);
  }
  video {
    width:100%; max-height:60vh; background:black;
  }
  #videoUrl {
    width:80%; padding:6px; margin:10px 0;
    background:var(--panel); border:1px solid var(--border); color:var(--text);
  }
  button {
    padding:6px 12px; margin:5px; background:var(--accent); border:none; color:white; cursor:pointer;
  }
  #messages {
    height:70%; overflow-y:auto; border:1px solid var(--border);
    padding:5px; margin-bottom:5px; background:var(--panel);
  }
  #onlineUsers {
    border:1px solid var(--border); background:var(--panel);
    padding:5px; margin-top:10px;
  }
  nav {
    display:flex; justify-content:space-around; padding:10px;
    background:var(--nav); border-top:1px solid var(--border);
  }
  nav a {
    color:var(--text); text-decoration:none; padding:5px 10px;
  }

  /* ğŸ”¹ å…¨å±èŠå¤©æµ®åŠ¨å±‚ */
  #chatOverlay {
    display: none;
    position: fixed;
    right: 10px;
    bottom: 10px;
    width: 300px;
    height: 40%;
    background: rgba(0,0,0,0.75);
    color: white;
    border-radius: 8px;
    overflow: hidden;
    z-index: 9999;
    display: flex;
    flex-direction: column;
  }
  #chatOverlayMessages {
    flex:1;
    overflow-y:auto;
    padding: 5px;
  }
  #chatOverlay .chat-input {
    display:flex;
    border-top:1px solid #444;
  }
  #chatOverlay input {
    flex:1;
    padding:5px;
    border:none;
    background:#222;
    color:white;
  }
  #chatOverlay button {
    padding:5px 10px;
    border:none;
    background:var(--accent);
    color:white;
  }
</style>
</head>
<body>
<header><h2>ä¸€èµ·çœ‹ç”µå½± â€” å—ä¿æŠ¤é¡µé¢</h2></header>
<main>
  <div id="leftPanel">
    <input type="text" id="videoUrl" placeholder="è¾“å…¥è§†é¢‘é“¾æ¥..." />
    <button onclick="loadVideo()">åŠ è½½è§†é¢‘</button>
    <video id="videoPlayer" controls playsinline webkit-playsinline></video>
  </div>
  <div id="rightPanel">
    <h3>èŠå¤©å®¤</h3>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." />
    <button onclick="sendMessage()">å‘é€</button>
    <div id="onlineUsers"><h4>åœ¨çº¿ç”¨æˆ·</h4><ul id="usersList"></ul></div>
  </div>
</main>
<nav>
  <a href="/">é¦–é¡µ</a>
  <a href="/letter.html">æ˜Ÿç©ºä¿¡ç¬º</a>
  <a href="/album.html">ç›¸å†Œ</a>
  <a href="/board.html">ç•™è¨€æœ¬</a>
  <a href="/watch.html">å½±é™¢</a>
</nav>

<!-- ğŸ”¹ å…¨å±èŠå¤©æµ®åŠ¨å±‚ -->
<div id="chatOverlay">
  <div id="chatOverlayMessages"></div>
  <div class="chat-input">
    <input type="text" id="overlayMessage" placeholder="è¾“å…¥æ¶ˆæ¯..." />
    <button onclick="sendOverlayMessage()">å‘é€</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onDisconnect, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmiAqdGejYqG8IvvoWm-nzqGLyj5TQsE",
  authDomain: "miao-fang.firebaseapp.com",
  databaseURL: "https://miao-fang-default-rtdb.firebaseio.com",
  projectId: "miao-fang",
  storageBucket: "miao-fang.firebasestorage.app",
  messagingSenderId: "117680297121",
  appId: "1:117680297121:web:0c4b8f6e0a4a9c9918cce0",
  measurementId: "G-YRQ71R9NCR"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let userNickname = "ç”¨æˆ·" + Math.floor(Math.random()*1000);
const messagesRef = ref(db, "messages");
const usersRef = ref(db, "onlineUsers");

// åœ¨çº¿ç”¨æˆ·ç®¡ç†
const userRef = push(usersRef);
set(userRef, { name: userNickname, time: serverTimestamp() });
onDisconnect(userRef).remove();

onChildAdded(usersRef, snap => {
  const li = document.createElement("li");
  li.id = "user-" + snap.key;
  li.textContent = snap.val().name;
  document.getElementById("usersList").appendChild(li);
});
import { onChildRemoved } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
onChildRemoved(usersRef, snap => {
  const li = document.getElementById("user-" + snap.key);
  if(li) li.remove();
});

// èŠå¤©æ¶ˆæ¯
onChildAdded(messagesRef, snap => {
  const msg = snap.val();
  const div = document.createElement("div");
  div.textContent = `[${msg.time}] ${msg.user}: ${msg.text}`;
  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;

  // åŒæ­¥æ˜¾ç¤ºåˆ°å…¨å±èŠå¤©æ¡†
  const div2 = document.createElement("div");
  div2.textContent = `[${msg.time}] ${msg.user}: ${msg.text}`;
  document.getElementById("chatOverlayMessages").appendChild(div2);
  document.getElementById("chatOverlayMessages").scrollTop = document.getElementById("chatOverlayMessages").scrollHeight;
});

window.sendMessage = function(){
  const input = document.getElementById("messageInput");
  if(input.value.trim()){
    push(messagesRef,{user:userNickname,text:input.value,time:new Date().toLocaleString()});
    input.value="";
  }
};

window.sendOverlayMessage = function(){
  const input = document.getElementById("overlayMessage");
  if(input.value.trim()){
    push(messagesRef,{user:userNickname,text:input.value,time:new Date().toLocaleString()});
    input.value="";
  }
};

// è§†é¢‘åŠ è½½
window.loadVideo = function(){
  const url=document.getElementById("videoUrl").value;
  if(url) document.getElementById("videoPlayer").src=url;
};

// ğŸ”¹ ç›‘å¬å…¨å±äº‹ä»¶ï¼Œæ˜¾ç¤º/éšè—èŠå¤©æµ®åŠ¨å±‚
document.addEventListener("fullscreenchange", () => {
  if(document.fullscreenElement){
    document.getElementById("chatOverlay").style.display="flex";
  }else{
    document.getElementById("chatOverlay").style.display="none";
  }
});
</script>
</body>
</html>
