<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä¸€èµ·çœ‹ç”µå½± â€” å—ä¿æŠ¤é¡µé¢</title>
<style>
  :root{--bg:#111;--panel:#1e1e1e;--accent:#ff4081;--muted:#444;--text:#fff}
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
  /* éšè—ä¸»å†…å®¹ç›´åˆ°è§£é” */
  #app{display:none;height:100%;flex-direction:column}
  header{background:#222;padding:10px;text-align:center;font-size:20px}
  main{flex:1;display:flex;flex-direction:row;padding:10px;overflow:auto}
  .left-panel{flex:3;display:flex;flex-direction:column;align-items:center}
  video{width:100%;max-width:800px;background:#000;margin-bottom:10px}
  .controls{margin-bottom:10px}
  .controls input{width:60%;padding:6px;border-radius:4px;border:none}
  .controls button{padding:6px 10px;margin-left:5px;border:none;border-radius:4px;background:var(--accent);color:#fff;cursor:pointer}
  .chat{width:100%;max-width:800px;background:var(--panel);border-radius:6px;display:flex;flex-direction:column;margin-top:10px}
  .chat-messages{flex:1;padding:10px;overflow:auto}
  .chat-input{display:flex;border-top:1px solid var(--muted)}
  .chat-input input{flex:1;padding:6px;border:none;border-radius:4px;margin-right:5px;background:#2a2a2a;color:#fff}
  .chat-input button{padding:6px 12px;border:none;border-radius:4px;background:#4caf50;color:white;cursor:pointer}
  .username-box{margin-bottom:8px}
  .volume-controls{margin:5px 0}
  .volume-controls label{margin-right:5px}
  .right-panel{flex:1;margin-left:10px;background:var(--panel);border-radius:6px;padding:10px}
  .user-list{max-height:400px;overflow:auto}
  .user-list div{padding:6px 4px;border-bottom:1px solid var(--muted)}
  footer{display:flex;justify-content:space-around;padding:10px 0;background:#222;flex-shrink:0}
  footer a{color:#fff;text-decoration:none}

  /* å¯†ç é®ç½© */
  #lockOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999}
  .lockBox{background:#161616;padding:24px;border-radius:8px;min-width:320px;max-width:90%;box-shadow:0 8px 30px rgba(0,0,0,0.6);text-align:center}
  .lockBox h2{margin:0 0 12px;font-size:18px;color:var(--text)}
  .lockBox input{width:100%;padding:10px;border-radius:6px;border:1px solid #333;background:#0f0f0f;color:#fff;margin-bottom:10px;box-sizing:border-box}
  .lockBox button{padding:8px 12px;border-radius:6px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  .lockBox .msg{color:#f88;margin-top:8px;height:18px;font-size:13px}
  .unlock-info{font-size:12px;color:#aaa;margin-top:8px}

  /* ç™»å‡ºæŒ‰é’® */
  #logoutBtn{position:fixed;top:12px;right:12px;padding:6px 10px;border-radius:6px;border:none;background:#444;color:#fff;cursor:pointer;z-index:2000;display:none}
</style>
</head>
<body>
  <!-- å¯†ç é®ç½© -->
  <div id="lockOverlay" aria-hidden="false">
    <div class="lockBox" role="dialog" aria-modal="true" aria-labelledby="lockTitle">
      <h2 id="lockTitle">è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
      <input id="passwordInput" type="password" placeholder="è¾“å…¥å¯†ç " aria-label="é¡µé¢è®¿é—®å¯†ç " />
      <div style="display:flex;gap:8px;justify-content:center">
        <button id="unlockBtn">è§£é”</button>
        <button id="clearBtn" style="background:#666">æ¸…é™¤</button>
      </div>
      <div class="msg" id="lockMsg"></div>
      <div class="unlock-info">æç¤ºï¼šä¼šè¯å†…è®°ä½å¯†ç ï¼Œå…³é—­é¡µé¢åéœ€é‡æ–°è¾“å…¥ã€‚</div>
    </div>
  </div>

  <!-- ç™»å‡º -->
  <button id="logoutBtn">ç™»å‡º</button>

  <!-- ä¸»åº”ç”¨ï¼ˆé»˜è®¤éšè—ï¼Œè§£é”åæ˜¾ç¤ºï¼‰ -->
  <div id="app">
    <header>ğŸ¬ æˆ‘å’ŒèŠ³çš„å½±é™¢ï¼ˆå—ä¿æŠ¤ï¼‰</header>
    <main>
      <div class="left-panel">
        <div class="controls">
          <input type="text" id="videoURL" placeholder="è¾“å…¥è§†é¢‘é“¾æ¥(mp4/m3u8)">
          <button id="loadVideoBtn">åŠ è½½è§†é¢‘</button>
        </div>
        <video id="videoPlayer" controls></video>
        <div class="volume-controls">
          <label>è§†é¢‘éŸ³é‡</label>
          <input type="range" id="videoVolume" min="0" max="1" step="0.01" value="1">
        </div>
        <div class="username-box">
          <input type="text" id="nickname" placeholder="è¾“å…¥æ˜µç§°">
        </div>
        <div class="chat">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯">
            <button id="sendBtn">å‘é€</button>
          </div>
        </div>
      </div>

      <div class="right-panel">
        <h3>åœ¨çº¿ç”¨æˆ·</h3>
        <div class="user-list" id="userList"></div>
      </div>
    </main>

    <footer>
      <a href="https://miao-murex.vercel.app/">é¦–é¡µ</a>
      <a href="https://miao-murex.vercel.app/letter.html">æ˜Ÿç©ºä¿¡ç¬º</a>
      <a href="https://miao-murex.vercel.app/album.html">ç›¸å†Œ</a>
      <a href="https://miao-murex.vercel.app/guestbook.html">ç•™è¨€æœ¬</a>
      <a href="https://miao-murex.vercel.app/watch.html">å½±é™¢</a>
    </footer>
  </div>

<script>
/*
  å®¢æˆ·ç«¯ç®€å•å¯†ç ä¿æŠ¤ï¼š
  - å¯†ç å¸¸é‡åœ¨å®¢æˆ·ç«¯ï¼ˆfm0328ï¼‰
  - æˆåŠŸåç”¨ sessionStorage è®°ä½ç™»å½•çŠ¶æ€
  - æœªç™»å½•æ—¶ä¸åŠ è½½ Firebaseï¼ˆé¿å…æœªæˆæƒè®¿é—®ï¼‰
*/

const CORRECT_PASSWORD = "fm0328";
const unlockBtn = document.getElementById('unlockBtn');
const clearBtn = document.getElementById('clearBtn');
const passwordInput = document.getElementById('passwordInput');
const lockMsg = document.getElementById('lockMsg');
const lockOverlay = document.getElementById('lockOverlay');
const app = document.getElementById('app');
const logoutBtn = document.getElementById('logoutBtn');

function showLock(msg = "") {
  lockOverlay.style.display = "flex";
  lockOverlay.setAttribute('aria-hidden','false');
  app.style.display = "none";
  logoutBtn.style.display = "none";
  lockMsg.textContent = msg;
}

function hideLock() {
  lockOverlay.style.display = "none";
  lockOverlay.setAttribute('aria-hidden','true');
  app.style.display = "flex";
  logoutBtn.style.display = "inline-block";
}

// æ£€æŸ¥ session
if (sessionStorage.getItem('watch_authed') === "1") {
  // å·²è®¤è¯ï¼šç›´æ¥åˆå§‹åŒ–åº”ç”¨
  hideLock();
  initializeProtectedApp();
} else {
  showLock();
  passwordInput.focus();
}

// è§£é”é€»è¾‘
unlockBtn.addEventListener('click', attemptUnlock);
passwordInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') attemptUnlock(); });
clearBtn.addEventListener('click', ()=>{
  passwordInput.value = "";
  lockMsg.textContent = "";
  passwordInput.focus();
});

logoutBtn.addEventListener('click', ()=>{
  sessionStorage.removeItem('watch_authed');
  // ç®€å•åˆ·æ–°é¡µé¢å›åˆ°é”å®šç•Œé¢
  window.location.reload();
});

function attemptUnlock(){
  const v = passwordInput.value || "";
  if (v === CORRECT_PASSWORD) {
    sessionStorage.setItem('watch_authed', "1");
    hideLock();
    // å»¶è¿Ÿåˆå§‹åŒ–ä»¥ç¡®ä¿ DOM å°±ç»ª
    setTimeout(()=>initializeProtectedApp(), 50);
  } else {
    lockMsg.textContent = "å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚";
    passwordInput.value = "";
    passwordInput.focus();
  }
}

/* ========== ä¸‹é¢å¼€å§‹å—ä¿æŠ¤çš„åº”ç”¨åˆå§‹åŒ–å‡½æ•° ==========
   æˆ‘ä»¬åŠ¨æ€å¯¼å…¥ Firebase å¹¶ç»‘å®šæ‰€æœ‰äº‹ä»¶ â€” åªæœ‰åœ¨è§£é”åæ‰è¿è¡Œ
*/
async function initializeProtectedApp(){
  // åŠ¨æ€å¯¼å…¥ firebase æ¨¡å—ï¼ˆé¿å…æœªæˆæƒç”¨æˆ·åŠ è½½ï¼‰
  const modApp = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
  const modDb = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
  const { initializeApp } = modApp;
  const { getDatabase, ref, push, onChildAdded, set, onValue, get, remove } = modDb;

  const firebaseConfig = {
    apiKey: "AIzaSyAwmiAqdGejYqG8IvvoWm-nzqGLyj5TQsE",
    authDomain: "miao-fang.firebaseapp.com",
    databaseURL: "https://miao-fang-default-rtdb.firebaseio.com",
    projectId: "miao-fang",
    storageBucket: "miao-fang.firebasestorage.app",
    messagingSenderId: "117680297121",
    appId: "1:117680297121:web:0c4b8f6e0a4a9c9918cce0",
    measurementId: "G-YRQ71R9NCR"
  };

  const appInstance = initializeApp(firebaseConfig);
  const db = getDatabase(appInstance);

  const videoRef = ref(db, "watch/video");
  const playRef = ref(db, "watch/playState");
  const messagesRef = ref(db, "watch/chat");
  const usersRef = ref(db, "watch/users");

  // DOM å…ƒç´ 
  const video = document.getElementById("videoPlayer");
  const videoURLInput = document.getElementById("videoURL");
  const loadVideoBtn = document.getElementById("loadVideoBtn");
  const videoVolumeInput = document.getElementById("videoVolume");
  const chatInput = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const nicknameInput = document.getElementById("nickname");
  const chatMessages = document.getElementById("chatMessages");
  const userListDiv = document.getElementById("userList");

  let userNickname = "";
  let userKey = null;

  // æ˜µç§°è¾“å…¥å¹¶æ³¨å†Œåœ¨çº¿ç”¨æˆ·
  nicknameInput.addEventListener("change", ()=>{ 
    userNickname = nicknameInput.value || "åŒ¿å"; 
    if(!userKey){
      userKey = push(usersRef, { name: userNickname }).key;
    } else {
      set(ref(db, "watch/users/" + userKey), { name: userNickname });
    }
  });

  // åŠ è½½è§†é¢‘ï¼ˆå°†é“¾æ¥å†™å…¥æ•°æ®åº“ï¼‰
  loadVideoBtn.addEventListener("click", ()=>{
    const url = videoURLInput.value.trim();
    if(url) set(videoRef, { url });
  });

  // è§†é¢‘åŠ è½½ + æ–°ç”¨æˆ·è‡ªåŠ¨è·Ÿéšæ’­æ”¾çŠ¶æ€ï¼ˆåœ¨ loadedmetadata åè®¾ç½® time & playï¼‰
  onValue(videoRef, async (snapshot)=>{
    const data = snapshot.val();
    if(data && data.url){
      const oldTime = video.currentTime;
      const wasPaused = video.paused;
      // åªæ›´æ”¹ srcï¼ˆæµè§ˆå™¨ä¼šç¼“å†²ï¼‰
      video.src = data.url;

      function initVideo(){
        // read play state
        get(playRef).then(stateSnapshot=>{
          const state = stateSnapshot.val();
          if(state){
            // è®¾ç½®æ—¶é—´å¹¶è·Ÿéšæ’­æ”¾çŠ¶æ€
            video.currentTime = state.time || 0;
            if(state.playing){
              // å°è¯•æ’­æ”¾ï¼ˆæµè§ˆå™¨å¯èƒ½è¦æ±‚ç”¨æˆ·äº¤äº’ï¼›è¿™æ˜¯æœ€å¥½çš„å°è¯•ï¼‰
              const p = video.play();
              if(p && p.catch) p.catch(()=>{/* é™é»˜å¤±è´¥ï¼ˆæµè§ˆå™¨ç­–ç•¥ï¼‰ */});
            } else {
              video.pause();
            }
          } else {
            // æ²¡æœ‰ play çŠ¶æ€ï¼Œä¿ç•™æœ¬åœ°æ’­æ”¾æ„å›¾
            video.currentTime = oldTime;
            if(!wasPaused){
              const p = video.play();
              if(p && p.catch) p.catch(()=>{});
            }
          }
        }).catch(()=>{/* ignore */});
        video.removeEventListener('loadedmetadata', initVideo);
      }

      video.addEventListener('loadedmetadata', initVideo);
    }
  });

  // é˜²æŠ–åŠ¨è‡ªåŠ¨æ ¡å‡†ï¼ˆåªåœ¨æ˜æ˜¾åå·®æ—¶è·³è½¬å¹¶åœ¨ seeked åæ’­æ”¾ï¼‰
  onValue(playRef, (snapshot)=>{
    const state = snapshot.val();
    if(state){
      const localTime = video.currentTime || 0;
      const diff = Math.abs(localTime - (state.time || 0));
      if(diff > 0.5){
        video.pause();
        // some browsers won't allow setting currentTime until metadata loaded; assume loaded
        try {
          video.currentTime = state.time || 0;
        } catch(e){
          // ignore errors; will attempt again on loadedmetadata
        }
        function playAfterSeek(){
          if(state.playing){
            const p = video.play();
            if(p && p.catch) p.catch(()=>{});
          }
          video.removeEventListener('seeked', playAfterSeek);
        }
        video.addEventListener('seeked', playAfterSeek);
      } else {
        if(state.playing && video.paused){
          const p = video.play();
          if(p && p.catch) p.catch(()=>{});
        }
        if(!state.playing && !video.paused){
          video.pause();
        }
      }
    }
  });

  // æœ¬åœ°æ’­æ”¾/æš‚åœäº‹ä»¶ä¸ŠæŠ¥åˆ°æ•°æ®åº“
  video.addEventListener("play", ()=>{ set(playRef, { playing:true, time: video.currentTime }); });
  video.addEventListener("pause", ()=>{ set(playRef, { playing:false, time: video.currentTime }); });

  // è§†é¢‘éŸ³é‡
  videoVolumeInput.addEventListener("input", ()=>{ video.volume = videoVolumeInput.value; });

  // èŠå¤©åŠŸèƒ½
  sendBtn.addEventListener("click", ()=>{
    const msg = chatInput.value.trim();
    if(msg){
      push(messagesRef, { name: userNickname || "åŒ¿å", text: msg, time: new Date().toLocaleTimeString() });
      chatInput.value = "";
    }
  });
  chatInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') sendBtn.click(); });

  onChildAdded(messagesRef, (snapshot)=>{
    const msg = snapshot.val();
    const div = document.createElement("div");
    div.textContent = `[${msg.time}] ${msg.name}: ${msg.text}`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });

  // åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆå®æ—¶ï¼‰
  onValue(usersRef, (snapshot)=>{
    const users = snapshot.val() || {};
    userListDiv.innerHTML = "";
    // ä¿æŒæ’å…¥é¡ºåº â€” ä½¿ç”¨ entries
    Object.entries(users).forEach(([k,u])=>{
      const div = document.createElement("div");
      div.textContent = u.name || "åŒ¿å";
      userListDiv.appendChild(div);
    });
  });

  // ç¦»å¼€æ—¶ä»åœ¨çº¿åˆ—è¡¨åˆ é™¤ï¼ˆå°½é‡å°è¯•ï¼‰
  window.addEventListener("beforeunload", ()=>{
    if(userKey){
      remove(ref(db, "watch/users/" + userKey)).catch(()=>{/* nothing */});
    }
  });

  // æ˜¾ç¤ºç™»å‡ºæŒ‰é’®ï¼ˆåœ¨è§£é”åï¼‰
  logoutBtn.style.display = "inline-block";
}
</script>
</body>
</html>
