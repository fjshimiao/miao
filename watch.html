<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ä¸€èµ·çœ‹ç”µå½± + è¯­éŸ³èŠå¤©</title>
<style>
body{margin:0;font-family:"Segoe UI",sans-serif;background:#111;color:#fff;display:flex;flex-direction:column;height:100vh;}
header{background:#222;padding:10px;text-align:center;font-size:1.2rem;}
.controls{display:flex;justify-content:center;align-items:center;padding:10px;background:#333;flex-wrap:wrap;}
.controls input[type="text"]{width:50%;padding:6px;border:none;border-radius:4px;margin:4px;}
.controls button{margin:4px;padding:6px 12px;border:none;border-radius:4px;background:#ff6699;color:#fff;cursor:pointer;}
.controls button:hover{background:#ff3366;}
.volume-controls{display:flex;justify-content:center;align-items:center;margin-top:4px;flex-wrap:wrap;}
.volume-controls label{margin:0 6px;}
main{flex:1;display:flex;flex-direction:row;position:relative;}
video{flex:3;background:black;width:100%;height:100%;}
.play-status-container{position:absolute;top:20px;left:20px;background:rgba(0,0,0,0.6);padding:6px 12px;border-radius:4px;font-size:1rem;color:#fff;z-index:10;display:flex;flex-direction:column;align-items:flex-start;}
.progress-bar{margin-top:4px;width:150px;height:6px;background:#555;border-radius:3px;overflow:hidden;cursor:pointer;position:relative;}
.progress-fill{width:0%;height:100%;background:#4caf50;border-radius:3px;}
.time-tip{margin-top:4px;font-size:0.8rem;color:#ffccaa;}
.chat{flex:1;display:flex;flex-direction:column;border-left:1px solid #444;background:#1e1e1e;}
.messages{flex:1;overflow-y:auto;padding:10px;}
.messages div{margin-bottom:8px;padding:6px;background:#333;border-radius:4px;}
.chat-input{display:flex;padding:10px;border-top:1px solid #444;}
.chat-input input{flex:1;padding:6px;border:none;border-radius:4px;}
.chat-input button{margin-left:10px;padding:6px 12px;border:none;border-radius:4px;background:#4caf50;color:white;cursor:pointer;}
footer{background:rgba(0,0,0,0.6);padding:10px;text-align:center;}
footer a{color:#fff;margin:0 15px;text-decoration:none;font-size:1.1rem;}
footer a:hover{color:#ff99aa;}
#voiceBtn{margin-top:6px;padding:4px 8px;font-size:0.9rem;background:#3399ff;border:none;border-radius:4px;color:#fff;cursor:pointer;}
#voiceBtn.active{background:#33cc33;}
#voiceList{margin-top:6px;width:100%;}
.peer-control{display:flex;align-items:center;margin-bottom:4px;}
.peer-control label{flex:1;}
.peer-control input{flex:1;}
</style>
</head>
<body>
<header>ä¸€èµ·çœ‹ç”µå½± + è¯­éŸ³èŠå¤© ğŸ¬ğŸ¤</header>

<div class="controls">
  <input id="videoURL" type="text" placeholder="è¾“å…¥è§†é¢‘ç›´é“¾åœ°å€ (mp4/m3u8)" />
  <button onclick="loadVideo()">åŠ è½½è§†é¢‘</button>
</div>

<div class="volume-controls">
  <label>è§†é¢‘éŸ³é‡: <input type="range" id="videoVol" min="0" max="1" step="0.01" value="0.8"></label>
</div>

<div style="margin:4px; text-align:center;">
  æ˜µç§°: <input id="nicknameInput" placeholder="è¾“å…¥æ˜µç§°" />
  <button onclick="updateNickname()">ä¿å­˜</button>
</div>

<main>
  <video id="videoPlayer" controls></video>
  <div class="play-status-container">
    <div id="playStatus">å·²æš‚åœ</div>
    <div class="progress-bar" id="progressBar">
      <div id="progressFill" class="progress-fill"></div>
    </div>
    <div class="time-tip" id="timeTip">00:00 / 00:00</div>
    <button id="voiceBtn">å¼€å¯è¯­éŸ³</button>
    <div id="voiceList"></div>
  </div>
  <div class="chat">
    <div class="messages" id="messages"></div>
    <div class="chat-input">
      <input id="chatInput" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..."/>
      <button onclick="sendMessage()">å‘é€</button>
    </div>
  </div>
</main>

<footer>
  <a href="index.html">é¦–é¡µ</a>
  <a href="letter.html">æ˜Ÿç©ºä¿¡ç¬º</a>
  <a href="album.html">ç›¸å†Œ</a>
  <a href="guestbook.html">ç•™è¨€æœ¬</a>
  <a href="watch.html">ä¸€èµ·çœ‹ç”µå½±</a>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwmiAqdGejYqG8IvvoWm-nzqGLyj5TQsE",
  authDomain: "miao-fang.firebaseapp.com",
  databaseURL: "https://miao-fang-default-rtdb.firebaseio.com",
  projectId: "miao-fang",
  storageBucket: "miao-fang.firebasestorage.app",
  messagingSenderId: "117680297121",
  appId: "1:117680297121:web:0c4b8f6e0a4b8f6e0a4a9c9918cce0",
  measurementId: "G-YRQ71R9NCR"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const messagesRef = ref(db, "watch/chat");
const videoRef = ref(db, "watch/video");
const stateRef = ref(db, "watch/state");
const peerIdsRef = ref(db,"watch/peers");

const videoPlayer = document.getElementById("videoPlayer");
const playStatus = document.getElementById("playStatus");
const progressFill = document.getElementById("progressFill");
const progressBar = document.getElementById("progressBar");
const timeTip = document.getElementById("timeTip");
const voiceBtn = document.getElementById("voiceBtn");
const videoVol = document.getElementById("videoVol");
const voiceList = document.getElementById("voiceList");
const nicknameInput = document.getElementById("nicknameInput");

function formatTime(seconds){
  const m=Math.floor(seconds/60).toString().padStart(2,'0');
  const s=Math.floor(seconds%60).toString().padStart(2,'0');
  return \`\${m}:\${s}\`;
}

// èŠå¤©
function sendMessage(){
  const input=document.getElementById("chatInput");
  if(input.value.trim()){
    push(messagesRef,{text:input.value});
    input.value="";
  }
}
window.sendMessage=sendMessage;
onValue(messagesRef,snapshot=>{
  const data=snapshot.val()||{};
  const messagesDiv = document.getElementById("messages");
  messagesDiv.innerHTML="";
  Object.values(data).forEach(msg=>{
    const div=document.createElement("div");
    div.textContent=msg.text;
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// è§†é¢‘åŠ è½½
function loadVideo(){
  const url=document.getElementById("videoURL").value.trim();
  if(url)set(videoRef,{url});
}
window.loadVideo=loadVideo;
onValue(videoRef,(snapshot)=>{
  const data=snapshot.val();
  if(data && data.url && videoPlayer.src!==data.url){
    videoPlayer.src=data.url;
    videoPlayer.currentTime=0;
  }
});

// è§†é¢‘åŒæ­¥
let isSyncing=false;
function syncState(){
  if(isSyncing) return;
  set(stateRef,{paused:videoPlayer.paused, currentTime:videoPlayer.currentTime});
}
videoPlayer.addEventListener("play",syncState);
videoPlayer.addEventListener("pause",syncState);
videoPlayer.addEventListener("seeking",syncState);
progressBar.addEventListener("click", e=>{
  const rect=progressBar.getBoundingClientRect();
  const percent=(e.clientX-rect.left)/rect.width;
  videoPlayer.currentTime = percent*(videoPlayer.duration||0);
  syncState();
});
onValue(stateRef,(snapshot)=>{
  const data=snapshot.val();
  if(!data) return;
  isSyncing=true;
  if(data.paused && !videoPlayer.paused) videoPlayer.pause();
  else if(!data.paused && videoPlayer.paused) videoPlayer.play().catch(()=>{});
  if(Math.abs(videoPlayer.currentTime-data.currentTime)>0.5) videoPlayer.currentTime=data.currentTime;
  const duration=videoPlayer.duration||1;
  progressFill.style.width = Math.min(100,(data.currentTime/duration)*100)+"%";
  playStatus.textContent = data.paused?"å·²æš‚åœ":"æ­£åœ¨æ’­æ”¾";
  timeTip.textContent = \`\${formatTime(data.currentTime)} / \${formatTime(duration)}\`;
  isSyncing=false;
});
videoPlayer.addEventListener("timeupdate",()=>{
  const current=videoPlayer.currentTime;
  const duration=videoPlayer.duration||1;
  progressFill.style.width=Math.min(100,(current/duration)*100)+"%";
  timeTip.textContent = \`\${formatTime(current)} / \${formatTime(duration)}\`;
});
videoVol.addEventListener("input", e=>videoPlayer.volume=e.target.value);

// ç”¨æˆ·æ˜µç§°
let userId = Date.now().toString();
function updateNickname(){
  const nickname = nicknameInput.value.trim() || "ç”¨æˆ·"+userId;
  set(ref(db,"watch/peers/"+userId), {online:true, nickname});
}
updateNickname();

// è¯­éŸ³èŠå¤©åŸºç¡€
let localStream=null;
let peers={};
async function startVoice(){
  if(localStream){
    localStream.getTracks().forEach(t=>t.stop());
    localStream=null;
    voiceBtn.classList.remove("active");
    voiceBtn.textContent="å¼€å¯è¯­éŸ³";
    voiceList.innerHTML="";
    return;
  }
  voiceBtn.classList.add("active");
  voiceBtn.textContent="å…³é—­è¯­éŸ³";
  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  set(ref(db,"watch/peers/"+userId), {online:true, nickname: nicknameInput.value || "ç”¨æˆ·"+userId});

  onValue(peerIdsRef,(snapshot)=>{
    const data = snapshot.val()||{};
    voiceList.innerHTML="";
    Object.keys(data).forEach(pid=>{
      if(pid===userId) return;
      const info = data[pid];
      const peerDiv=document.createElement("div");
      peerDiv.className="peer-control";
      const label=document.createElement("label");
      label.textContent = info.nickname || "ç”¨æˆ·"+pid;
      const slider=document.createElement("input");
      slider.type="range"; slider.min="0"; slider.max="1"; slider.step="0.01"; slider.value="1";
      const audio=document.createElement("audio");
      audio.autoplay=true;
      audio.volume=1;
      // slideræ§åˆ¶éŸ³é‡
      slider.addEventListener("input", e=>audio.volume=e.target.value);
      peerDiv.appendChild(label);
      peerDiv.appendChild(slider);
      voiceList.appendChild(peerDiv);
      peers[pid]={audio};
    });
  });
}
voiceBtn.addEventListener("click", startVoice);
</script>
</body>
</html>
