<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>一起看电影 — 受保护页面</title>
<style>
  :root{--bg:#111;--panel:#1e1e1e;--accent:#ff4081;--muted:#444;--text:#fff}
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
  #app{display:none;height:100%;flex-direction:column}
  header{background:#222;padding:10px;text-align:center;font-size:20px}
  main{flex:1;display:flex;flex-direction:row;padding:10px;overflow:auto}
  .left-panel{flex:3;display:flex;flex-direction:column;align-items:center}
  video{width:100%;max-width:800px;background:#000;margin-bottom:10px}
  .controls{margin-bottom:10px}
  .controls input{width:60%;padding:6px;border-radius:4px;border:none}
  .controls button{padding:6px 10px;margin-left:5px;border:none;border-radius:4px;background:var(--accent);color:#fff;cursor:pointer}
  .chat{width:100%;max-width:800px;background:var(--panel);border-radius:6px;display:flex;flex-direction:column;margin-top:10px}
  .chat-messages{flex:1;padding:10px;overflow:auto}
  .chat-input{display:flex;border-top:1px solid var(--muted)}
  .chat-input input{flex:1;padding:6px;border:none;border-radius:4px;margin-right:5px;background:#2a2a2a;color:#fff}
  .chat-input button{padding:6px 12px;border:none;border-radius:4px;background:#4caf50;color:white;cursor:pointer}
  .username-box{margin-bottom:8px}
  .volume-controls{margin:5px 0}
  .right-panel{flex:1;margin-left:10px;background:var(--panel);border-radius:6px;padding:10px}
  .user-list{max-height:400px;overflow:auto}
  .user-list div{padding:6px 4px;border-bottom:1px solid var(--muted)}
  footer{display:flex;justify-content:space-around;padding:10px 0;background:#222;flex-shrink:0}
  footer a{color:#fff;text-decoration:none}
  #lockOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999}
  .lockBox{background:#161616;padding:24px;border-radius:8px;min-width:320px;max-width:90%;box-shadow:0 8px 30px rgba(0,0,0,0.6);text-align:center}
  .lockBox h2{margin:0 0 12px;font-size:18px;color:var(--text)}
  .lockBox input{width:100%;padding:10px;border-radius:6px;border:1px solid #333;background:#0f0f0f;color:#fff;margin-bottom:10px;box-sizing:border-box}
  .lockBox button{padding:8px 12px;border-radius:6px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  .lockBox .msg{color:#f88;margin-top:8px;height:18px;font-size:13px}
  .unlock-info{font-size:12px;color:#aaa;margin-top:8px}
  #logoutBtn{position:fixed;top:12px;right:12px;padding:6px 10px;border-radius:6px;border:none;background:#444;color:#fff;cursor:pointer;z-index:2000;display:none}
</style>
</head>
<body>
  <!-- 密码遮罩 -->
  <div id="lockOverlay">
    <div class="lockBox">
      <h2>请输入访问密码</h2>
      <input id="passwordInput" type="password" placeholder="输入密码"/>
      <div style="display:flex;gap:8px;justify-content:center">
        <button id="unlockBtn">解锁</button>
        <button id="clearBtn" style="background:#666">清除</button>
      </div>
      <div class="msg" id="lockMsg"></div>
      <div class="unlock-info">提示：会话内记住密码，关闭页面后需重新输入。</div>
    </div>
  </div>
  <button id="logoutBtn">登出</button>

  <!-- 主应用 -->
  <div id="app">
    <header>🎬 我和芳的影院（受保护）</header>
    <main>
      <div class="left-panel">
        <div class="controls">
          <input type="text" id="videoURL" placeholder="输入视频链接(mp4/m3u8)">
          <button id="loadVideoBtn">加载视频</button>
        </div>
        <video id="videoPlayer" controls></video>
        <div class="volume-controls">
          <label>视频音量</label>
          <input type="range" id="videoVolume" min="0" max="1" step="0.01" value="1">
        </div>
        <div class="username-box">
          <input type="text" id="nickname" placeholder="输入昵称">
        </div>
        <div class="chat">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input">
            <input type="text" id="chatInput" placeholder="输入消息">
            <button id="sendBtn">发送</button>
          </div>
        </div>
      </div>
      <div class="right-panel">
        <h3>在线用户</h3>
        <div class="user-list" id="userList"></div>
      </div>
    </main>
    <footer>
      <a href="https://miao-murex.vercel.app/">首页</a>
      <a href="https://miao-murex.vercel.app/letter.html">星空信笺</a>
      <a href="https://miao-murex.vercel.app/album.html">相册</a>
      <a href="https://miao-murex.vercel.app/guestbook.html">留言本</a>
      <a href="https://miao-murex.vercel.app/watch.html">影院</a>
    </footer>
  </div>

<script>
const CORRECT_PASSWORD = "fm0328";
const unlockBtn = document.getElementById('unlockBtn');
const clearBtn = document.getElementById('clearBtn');
const passwordInput = document.getElementById('passwordInput');
const lockMsg = document.getElementById('lockMsg');
const lockOverlay = document.getElementById('lockOverlay');
const app = document.getElementById('app');
const logoutBtn = document.getElementById('logoutBtn');

function showLock(msg=""){lockOverlay.style.display="flex";app.style.display="none";logoutBtn.style.display="none";lockMsg.textContent=msg;}
function hideLock(){lockOverlay.style.display="none";app.style.display="flex";logoutBtn.style.display="inline-block";}

if(sessionStorage.getItem('watch_authed')==="1"){hideLock();initializeProtectedApp();}else{showLock();passwordInput.focus();}
unlockBtn.addEventListener('click',attemptUnlock);
passwordInput.addEventListener('keypress',e=>{if(e.key==='Enter')attemptUnlock();});
clearBtn.addEventListener('click',()=>{passwordInput.value="";lockMsg.textContent="";passwordInput.focus();});
logoutBtn.addEventListener('click',()=>{sessionStorage.removeItem('watch_authed');window.location.reload();});

function attemptUnlock(){
  if(passwordInput.value===CORRECT_PASSWORD){sessionStorage.setItem('watch_authed',"1");hideLock();setTimeout(()=>initializeProtectedApp(),50);}
  else{lockMsg.textContent="密码错误，请重试。";passwordInput.value="";passwordInput.focus();}
}

async function initializeProtectedApp(){
  const modApp=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
  const modDb=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
  const {initializeApp}=modApp;
  const {getDatabase,ref,push,onChildAdded,set,onValue,get,remove,onDisconnect}=modDb;

  const firebaseConfig={apiKey:"AIzaSyAwmiAqdGejYqG8IvvoWm-nzqGLyj5TQsE",authDomain:"miao-fang.firebaseapp.com",databaseURL:"https://miao-fang-default-rtdb.firebaseio.com",projectId:"miao-fang",storageBucket:"miao-fang.firebasestorage.app",messagingSenderId:"117680297121",appId:"1:117680297121:web:0c4b8f6e0a4a9c9918cce0",measurementId:"G-YRQ71R9NCR"};
  const appInstance=initializeApp(firebaseConfig);
  const db=getDatabase(appInstance);

  const videoRef=ref(db,"watch/video");
  const playRef=ref(db,"watch/playState");
  const messagesRef=ref(db,"watch/chat");
  const usersRef=ref(db,"watch/users");

  const video=document.getElementById("videoPlayer");
  const videoURLInput=document.getElementById("videoURL");
  const loadVideoBtn=document.getElementById("loadVideoBtn");
  const videoVolumeInput=document.getElementById("videoVolume");
  const chatInput=document.getElementById("chatInput");
  const sendBtn=document.getElementById("sendBtn");
  const nicknameInput=document.getElementById("nickname");
  const chatMessages=document.getElementById("chatMessages");
  const userListDiv=document.getElementById("userList");

  let userNickname="匿名";
  let userKey=null;

  // 每次进入清空聊天记录
  remove(messagesRef);

  nicknameInput.addEventListener("change",()=>{
    userNickname=nicknameInput.value||"匿名";
    if(!userKey){
      const newUserRef=push(usersRef,{name:userNickname});
      userKey=newUserRef.key;
      onDisconnect(newUserRef).remove(); // 离开自动移除
    }else{
      set(ref(db,"watch/users/"+userKey),{name:userNickname});
    }
  });

  loadVideoBtn.addEventListener("click",()=>{
    const url=videoURLInput.value.trim();
    if(url)set(videoRef,{url});
  });

  onValue(videoRef,(snapshot)=>{
    const data=snapshot.val();
    if(data&&data.url){
      video.src=data.url;
      video.addEventListener("loadedmetadata",()=>{
        get(playRef).then(s=>{
          const state=s.val();
          if(state){
            video.currentTime=state.time||0;
            if(state.playing)video.play().catch(()=>{});
            else video.pause();
          }
        });
      },{once:true});
    }
  });

  onValue(playRef,(snapshot)=>{
    const state=snapshot.val();
    if(state){
      const diff=Math.abs(video.currentTime-(state.time||0));
      if(diff>0.5)video.currentTime=state.time||0;
      if(state.playing&&!video.paused){}else if(state.playing&&video.paused){video.play().catch(()=>{});}
      if(!state.playing&&!video.paused)video.pause();
    }
  });

  video.addEventListener("play",()=>{set(playRef,{playing:true,time:video.currentTime});});
  video.addEventListener("pause",()=>{set(playRef,{playing:false,time:video.currentTime});});
  video.addEventListener("seeked",()=>{set(playRef,{playing:!video.paused,time:video.currentTime});});

  videoVolumeInput.addEventListener("input",()=>{video.volume=videoVolumeInput.value;});

  sendBtn.addEventListener("click",()=>{
    const msg=chatInput.value.trim();
    if(msg){
      push(messagesRef,{name:userNickname,text:msg,time:new Date().toLocaleTimeString()});
      chatInput.value="";
    }
  });
  chatInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendBtn.click();});

  onChildAdded(messagesRef,(snapshot)=>{
    const msg=snapshot.val();
    const div=document.createElement("div");
    div.textContent=`[${msg.time}] ${msg.name}: ${msg.text}`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop=chatMessages.scrollHeight;
  });

  onValue(usersRef,(snapshot)=>{
    const users=snapshot.val()||{};
    userListDiv.innerHTML="";
    Object.values(users).forEach(u=>{
      const div=document.createElement("div");
      div.textContent=u.name||"匿名";
      userListDiv.appendChild(div);
    });
  });

  window.addEventListener("beforeunload",()=>{
    if(userKey)remove(ref(db,"watch/users/"+userKey)).catch(()=>{});
  });
}
</script>
</body>
</html>
